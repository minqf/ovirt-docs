<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Installation_Guide.ent">
%BOOK_ENTITIES;
]>

<chapter id="chap-Installation_Guide-Setting_Up_Network">
	<title>Network Setup</title>
	<para>
		This chapter provides instruction on configuring networking for the oVirt environment. For information about managing networking, including maintenance, refer to the <citetitle>oVirt Administration Guide</citetitle>.
	</para>
	<para>
	  oVirt uses networking to support almost every aspect of operations. Storage, host management, user connections, and virtual machine connectivity, for example, all rely on a well planned and configured network to deliver optimal performance. Setting up networking is a vital prerequisite for a oVirt environment because it is much simpler to plan for your projected networking requirements and implement your network accordingly than it is to discover your networking requirements through use and attempt to alter your network configuration retroactively.
	</para>
	<para>
		 A familiarity with the network concepts and their use is highly recommended when planning and setting up networking in a oVirt environment. This document does not describe the concepts, protocols, requirements or general usage of bonds, bridges and logical networks. It is recommended that you read your network hardware vendor's guides for more information on managing networking.
	</para>
	<section id="sect-Installation_Guide-Setting_Up_Networking-Determine-Needs">
		<title>Determine Network Requirements</title>
		<para>
		  It is possible to deploy a oVirt environment with no consideration given to networking at all. Simply ensuring that each physical machine in the environment has at least one <firstterm>Network Interface Controller</firstterm>(<acronym>NIC</acronym>) cabled to a switch and assigned an IP address by DHCP is enough to begin using a oVirt environment. While it is true that this approach to networking will provide a functional environment, it will not provide an optimal environment. Because network usage varies by task or action, grouping related tasks or functions into specialized networks can improve performance while simplifying the troubleshooting of network issues. By default, the oVirt Engine creates one logical network called <systemitem>ovirt</systemitem> and uses this logical network for all traffic. 
		</para>
		<para>
		  The <systemitem>ovirt</systemitem> network is created and labeled as the <guilabel>Management</guilabel> logical network. The <systemitem>ovirt</systemitem> logical network is intended for management traffic between the oVirt Engine and virtualization hosts. Other types of traffic that are common to all oVirt environments are: 
		    <itemizedlist>
		      <listitem><para>Display related traffic.</para></listitem>
		      <listitem><para>General virtual machine networking traffic.</para></listitem>
		      <listitem><para>Storage related traffic.</para></listitem>
		    </itemizedlist>
</para>
<para>For the oVirt environment to perform optimally, these types of traffic should be separated. This is easily accomplished by assigning each type of network traffic to a different logical network. Each logical network must be associated with a cabled, active network device. The network device that supports each logical network can be physical, a <acronym>NIC</acronym> or logical, like a bond device or virtual NIC(<acronym>VNIC</acronym>). 
</para>
<para>The number of logical networks that can be defined and implemented in a oVirt environment is limited by the number of network interfaces present on the virtualization hosts in the environment. Each logical network needs at least one physical device to support it. Because a logical network must be implemented for each host in a cluster for the logical network to be operational, the number of logical networks that can be implemented in a given cluster is limited by the host in a cluster with the fewest NICs. 
		</para>
	      </section>
	      
	      <section id="Maintaining-Logical-Networks">
	<title>Logical Networks</title>
	<para>
	  By default the management network, called <guilabel>ovirt</guilabel> is defined for a data center. New logical networks, for example for data, storage or display can be
	    defined by the administrator. In general, logical networks are created to isolate network traffic by functionality or virtualize a physical topology. In addition, other networks can be used to segregate virtual machine traffic from the management networks, or isolate traffic between groups of virtual machines in the same cluster. In oVirt Engine, network definition, type and function are encapsulated in a logical entity called a <systemitem>Logical Network</systemitem>. For example, a data center may have the following networks, 
	</para>
	<itemizedlist>
		<listitem>
			<para>Guest data network</para>
		</listitem>
		<listitem>
			<para>Storage network access</para>
		</listitem>
		<listitem>
			<para>Management network</para>
		</listitem>
		<listitem>
			<para>Display network (for SPICE or VNC)</para>
		</listitem>
	</itemizedlist>
	<warning>
		<title>Warning:</title>
	<para>Do not change networking in a data center or a cluster if any hosts are running. This may make the host unreachable.</para>
	</warning>


   <section id="Evaluation_Guide-Multiple_Host-Configure_Network">
    <title>Adding Logical Networks</title>

	<para><!--This definition is a mare declaration of the common properties of the network, this logical network is then assigned as a required resource of
a cluster in the data center.-->
	A logical network is assigned by an administrator as a required resource of a cluster in a data center. By extension all hosts in a cluster must have the same set of
logical networks implemented. The implementation itself may vary from host to host (IP and bonding properties). Therefore, to configure a network, you need to
  first define the network for a data center and then apply this network to each host in a cluster. By default the management network (<systemitem>ovirt</systemitem>) is defined for a data center.
	</para>
	<para>
	  This section describes how to define a <systemitem>Storage</systemitem> logical network for a data center, apply the <systemitem>Storage</systemitem> logical network to a cluster, and implement the <systemitem>Storage</systemitem> logical network for hosts. This process can be repeated for each logical network being added to a data center.  
	</para>
		<orderedlist id="manage-logical-networks">
		 <title>To define logical networks in a cluster</title>
			<listitem>
			 <para>
			Navigate to the <guilabel>Tree</guilabel> pane and click the <guilabel>Expand All</guilabel> button. Under System, click
select the data center to which a new logical network will be added. On the results list, the selected data center displays.
			 </para>
			</listitem>
			<listitem>
			 <para>
			On the details pane, select the <guilabel>Logical Networks</guilabel> subtab. This displays the existing logical 
			networks. At the minimum, the default <emphasis role="bold">ovirt</emphasis> network is listed. 
			 </para>
			</listitem>
			<listitem>
			 <para>
			   Click <guilabel>New</guilabel>. The <guilabel>New Logical Network</guilabel> dialog displays.</para>
			   <para>
			     <figure id="add-logical-network">
				  <title>Add a logical network.</title>
				 	<mediaobject>
				 	  <imageobject>
						<imagedata fileref="images/logical-network-add_new.png" format="PNG"/>
				  	  </imageobject>
				 	 </mediaobject>
				</figure>
			      </para>
			      <para>
			Fill in the <guilabel>Name</guilabel> and <guilabel>Description</guilabel> fields, and select the desired cluster from the <guilabel>Assign Networks to Cluster(s)</guilabel> section, to automatically add the <systemitem>Storage</systemitem> network to the cluster.
			      </para>
			</listitem>
			<listitem>
			 <para>
			Click <guilabel>OK</guilabel> to create the new logical network. 
			 </para>
			</listitem>
		</orderedlist>
		<formalpara><title>Result:</title>
	<para>You have defined this network as a resource required by the a cluster in the data center. You can now
	  add this resource to the hosts in the cluster.</para></formalpara>

		<orderedlist id="add-network-to-hosts">
		 <title>To add network to hosts</title>
			<listitem>
			 <para>
			Back on the <guilabel>Tree</guilabel> pane, click
<menuchoice><guimenu>Default</guimenu><guisubmenu>Clusters</guisubmenu><guisubmenu>Default</guisubmenu><guimenuitem>Hosts</guimenuitem></menuchoice>. The
<guilabel>Hosts</guilabel> tab displays a list of available hosts. 
			 </para>
			</listitem>
			<listitem>
			 <para>
			For each of your installed hosts, perform the following tasks:
			 </para>
				<orderedlist>
				 <listitem>
				  <para>
				    Click on the host. On the <guilabel>details</guilabel> pane, select the <guilabel>Network Interfaces</guilabel> tab.  
				  </para>
				 </listitem>
				 <listitem>
				  <para>
				A list of network interfaces available for this host displays. 
				One of them will already have the management network (ovirt)
configured. 
				  </para>
				 </listitem>
				 <listitem>
				  <para>
				Select the interface on which to configure the newly added network and click the <guibutton>Add/Edit</guibutton> button. The
<guilabel>Edit Network Interface</guilabel> dialog displays. 
				<figure id="edit-network-interface">
				  <title>Edit network interface</title>
				 	<mediaobject>
				 	  <imageobject>
						<imagedata fileref="images/edit-network-interface.png" format="PNG"/>
				  	  </imageobject>
				 	 </mediaobject>
				</figure>
				
				  Configure the following options:
					<itemizedlist>
					 <listitem><para>Under <guilabel>Network</guilabel>, select your newly created storage network.</para></listitem>
					 <listitem><para>Select the <guilabel>Static</guilabel> or <guilabel>DHCP</guilabel> radio button. If static was selected, enter the <guilabel>IP</guilabel> and
<guilabel>Subnet Mask</guilabel> you have prepared as part of the prerequisites to this procedure.</para></listitem>
					 <listitem><para>Select the <guilabel>Save network configuration</guilabel> checkbox.</para></listitem>
					</itemizedlist>
				  </para>
				 </listitem>
				 <listitem>
				  <para>
				Click <guibutton>OK</guibutton>. 
				  </para>
				 </listitem>
				</orderedlist>
			</listitem>
		</orderedlist>
		<formalpara><title>Result:</title>
		<para>You have now added a new <systemitem>Storage</systemitem> network to your data center. On the <guilabel>Logical Networks</guilabel> tab of the <guilabel>Default</guilabel>
		data center, you should have at least two networks - <systemitem>ovirt</systemitem> and <systemitem>Storage</systemitem>. You can repeat this process for each logical network being added to a data center</para>
	      </formalpara>
<section id="Logical-Networks-Designate_Display_Network">
		  <title>Designate Display Network</title>
		  <para>A logical network created to carry display traffic must be designated as the <guilabel>Display Network</guilabel> using the oVirt Engine administration portal.</para>
<orderedlist id="set-as-display">
		 <title>To designate a new logical network as the display network</title>
		 <listitem><para>Select the <guilabel>Clusters</guilabel> tab, and select the cluster you wish to designate a display network for.</para></listitem>
		 <listitem><para>Select the <guilabel>Logical Networks</guilabel>.</para></listitem>
		 <listitem><para>Select the logical network that you wish to designate as the Display network.</para></listitem>
		 <listitem><para>Click the <guibutton>Set as Display</guibutton> button.</para></listitem>
		 <listitem><para><guilabel>Update Display Network</guilabel> displays in the <guilabel>Events</guilabel> tab.</para></listitem>
	       </orderedlist>
	       <formalpara><title>Result:</title><para> You have successfully designated a logical network as the display network.</para></formalpara>
	     </section>
  </section>
		</section>

	<section id="sect-Installation_Guide-Setting_Up_Networking_Bond_Device">
		<title>Set Up a Bond Device</title>
		  <para>
			A <firstterm>Bond</firstterm> aggregates multiple NICs in a parallel manner to provide combined speed that is beyond single NIC speeds. Bonding provides increased fault tolerance by increasing the number of failures required for networking to fail completely. The NICs that form a bond device must be of the same make and model in order to ensure that both devices support the same options and modes.
		</para>
		<para>
			The packet dispersal algorithm for a bond is determined by the bonding mode used. 
		</para>
	
		<bridgehead>Bonding Modes</bridgehead>
		<para>
			oVirt supports the following common bonding modes:
		</para>
		<itemizedlist>
			<!--<listitem>
				<para>Mode 0 (round-robin policy) transmits packets to interfaces in sequential order. Packet transmission occurs in iterations that begin with the first available interface and end with the last available interface. Similarly, all subsequent iterations initiate with the first available interface. Mode 0 offers fault tolerance and load balancing to the network. However, mode 0 cannot be used in conjunction with bridges, therefore it is not supported in oVirt.</para>
			      </listitem>-->
			<listitem>
				<para>(Mode 1) Active-backup policy sets all interfaces to the backup state while one remains active. Upon failure on the active interface, a backup interface replaces it as the only active interface in the bond. The MAC address of the bond in mode 1 is visible on only one port (the network adapter), to prevent confusion for the switch. Mode 1 provides fault tolerance and is supported in oVirt.</para>
			</listitem>
			<listitem>
				<para>(Mode 2) XOR policy selects an interface to transmit packages to based on the result of a XOR operation on the source and destination MAC addresses multiplied by the modulo slave count. This calculation ensures that the same interface is selected for each destination MAC address used. Mode 2 provides fault tolerance and load balancing and is supported in oVirt.</para>
			</listitem>
			<!--
			<listitem>
				<para>(Mode 3) Broadcast policy transmits all packages to all interfaces. Mode 3 provides fault tolerance and is supported in oVirt.</para>
			</listitem>
			-->
			<listitem>
				<para>(Mode 4) IEEE 802.3ad policy creates aggregation groups for which included interfaces share the speed and duplex settings. Mode 4 uses all interfaces in the active aggregation group in accordance with the IEEE 802.3ad specification and is supported in oVirt.</para>
			</listitem>
			<listitem>
				<para>(Mode 5) Adaptive transmit load balancing policy ensures the outgoing traffic distribution is according to the load on each interface and that the current interface receives all incoming traffic. If the interface assigned to receive traffic fails, another interface is assigned the receiving role instead. Mode 5 is supported in oVirt.</para>
			</listitem>
			<!--<listitem>
				<para>Mode 6 (adaptive load balancing policy)combines mode 5 (adaptive transmit load balancing policy) with receive load balancing for IPV4 traffic without any special switch requirements. ARP negotiation is used for balancing the receive load. Mode 6 cannot be used in conjunction with bridges, therefore it is not supported in oVirt.</para>
			      </listitem>-->
		</itemizedlist>
		<orderedlist>
		  <title>To create a bond device using the oVirt Engine administration portal</title>
		  <listitem><para>Click the <guilabel>Hosts</guilabel> tab.</para></listitem>
		  <listitem><para>Select the host for which a bond device will be created.</para></listitem>
		  <listitem><para>Click the <guilabel>Network Interfaces</guilabel> tab in the details pane.</para></listitem>
		  <listitem><para>Select the devices that will be included in the bond, ensuring they are all of the same make and model.</para>
		  <para><figure id="bond-button">
				  <title>Bond Network Devices.</title>
				 	<mediaobject>
				 	  <imageobject>
						<imagedata fileref="images/bond_button.png" format="PNG"/>
				  	  </imageobject>
				 	 </mediaobject>
				       </figure>
				     </para>
				   </listitem>
				   <listitem>
				       <para>Click the <guibutton>Bond</guibutton> button. The <guilabel>Bond Network Interfaces</guilabel> dialog displays.</para>
				   	 <para><figure id="bond-dialog">
				  <title>Bond Devices Dialogue.</title>
				 	<mediaobject>
				 	  <imageobject>
						<imagedata fileref="images/bond_interfaces_dialog.png" format="PNG"/>
				  	  </imageobject>
				 	 </mediaobject>
				       </figure></para>
				       <para>Enter the configuration information for the new bond device including:
		    <itemizedlist>
		      <listitem><para>Bond Name: select one from the drop down list.</para></listitem>
		      <listitem><para>Network: the logical network that the bond device will be a part of.</para></listitem>
		      <listitem><para>Bonding mode: the bonding mode that provides the desired functionality.</para></listitem>
		      <listitem><para>IP address assignment mechanism: either DHCP or Static. If static, then IP, Subnet Mask, and Default Gateway must all be set manually.</para></listitem>
		      <listitem><para>Check connectivity: ensure that the bond device is functional upon creation.</para></listitem>
		      <listitem><para>Save Network Configuration: make the bond device persistent through reboots.</para></listitem>
		    </itemizedlist>
			</para></listitem>
			<listitem><para>Click the <guibutton>OK</guibutton>. The <guilabel>Events</guilabel> tab displays <guilabel>Bond device created</guilabel>.</para></listitem>
		</orderedlist>
		<formalpara><title>Result:</title><para>A bond device is listed in the <guilabel>Network Interfaces</guilabel> tab of the details pain for the selected host</para></formalpara>
		<formalpara><title>To enable bonding on a switch</title>
		<para>Bonding must be enabled for the ports that the host uses on the switch it is connected to. The process by which bonding is enabled is slightly different for each switch, consult the manual provided by your switch vendor for detailed information on how to enable bonding.</para>		
	      </formalpara>
	      <para>The following is an bond example configuration for a switch. Your switch configuration may look different.</para>
	      <screen>
  interface Port-channel11
  switchport access vlan 153
  switchport mode access
  spanning-tree portfast disable
  spanning-tree bpduguard disable
  spanning-tree guard root
  
  interface GigabitEthernet0/16
  switchport access vlan 153
  switchport mode access
  channel-group 11 mode active
 
  interface GigabitEthernet0/17
  switchport access vlan 153
  switchport mode access
</screen>
<important><para>For every type of switch it is important to set up the switch bonding with the <firstterm>Link Aggregation Control Protocol</firstterm>(<acronym>LACP</acronym>) protocol and <emphasis>not</emphasis> the Cisco <firstterm>Port Aggregation Protocol</firstterm>(<acronym>PAgP</acronym>) protocol.</para></important>
	      </section>
</chapter>

